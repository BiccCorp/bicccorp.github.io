<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz SÅ‚Ã³wek - BiccCorp Blog</title>
  <link rel="stylesheet" href="../style.css" />
  <script src="../fade.js"></script>
  <style>
    #quiz-root {
      max-width: 520px;
      margin: 0 auto;
      padding: 1.5rem 0 2rem;
    }

    #lang-screen { text-align: center; }
    #lang-screen h2 {
      font-size: 1rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      opacity: 0.5;
      margin-bottom: 1.5rem;
    }

    .lang-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.6rem;
      margin-bottom: 1.5rem;
    }
    @media (max-width: 420px) { .lang-grid { grid-template-columns: repeat(2,1fr); } }

    .lang-btn {
      background: transparent;
      border: 1px solid currentColor;
      color: inherit;
      font: inherit;
      font-size: 0.82rem;
      padding: 0.6rem 0.5rem;
      cursor: pointer;
      letter-spacing: 0.06em;
      transition: opacity 0.15s, background 0.15s;
      display: flex; flex-direction: column;
      align-items: center; gap: 0.25rem;
    }
    .lang-btn:hover { opacity: 0.65; }
    .lang-btn.selected { background: currentColor; color: var(--bg, #0a0a0f); }
    .lang-flag { font-size: 1.4rem; }

    .diff-row {
      display: flex; gap: 0.5rem;
      justify-content: center;
      margin-bottom: 1.5rem;
      align-items: center;
    }
    .diff-label { font-size: 0.78rem; opacity: 0.4; letter-spacing: 0.08em; }
    .diff-btn {
      background: transparent; border: 1px solid currentColor;
      color: inherit; font: inherit; font-size: 0.78rem;
      padding: 0.35rem 0.9rem; cursor: pointer;
      letter-spacing: 0.08em; opacity: 0.45; transition: opacity 0.15s;
    }
    .diff-btn:hover { opacity: 0.8; }
    .diff-btn.active { opacity: 1; border-width: 2px; }

    .start-btn {
      background: transparent; border: 1px solid currentColor;
      color: inherit; font: inherit; font-size: 0.85rem;
      padding: 0.65rem 2.5rem; cursor: pointer;
      text-transform: uppercase; letter-spacing: 0.12em;
      transition: opacity 0.2s;
    }
    .start-btn:hover { opacity: 0.6; }
    .start-btn:disabled { opacity: 0.2; cursor: not-allowed; }

    .info-note {
      font-size: 0.72rem; opacity: 0.35;
      text-align: center; margin-top: 1rem;
      letter-spacing: 0.05em; line-height: 1.8;
    }

    #quiz-screen { display: none; }

    .quiz-meta {
      display: flex; justify-content: space-between;
      align-items: center; font-size: 0.75rem;
      opacity: 0.5; letter-spacing: 0.08em;
      margin-bottom: 1.2rem; text-transform: uppercase;
      flex-wrap: wrap; gap: 0.3rem;
    }
    .quiz-meta button {
      background: transparent; border: none; color: inherit;
      font: inherit; font-size: 0.72rem; cursor: pointer;
      opacity: 0.7; padding: 0; letter-spacing: 0.08em;
    }
    .quiz-meta button:hover { opacity: 1; }

    .score-bar {
      display: flex; gap: 0.4rem;
      align-items: center; margin-bottom: 1.5rem;
    }
    .score-seg {
      width: 18px; height: 6px; border: 1px solid currentColor;
      opacity: 0.2; transition: opacity 0.3s, background 0.3s;
    }
    .score-seg.correct { background: currentColor; opacity: 1; }
    .score-seg.wrong   { border-color: #e74c3c; opacity: 1; }
    .score-label { margin-left: auto; font-size: 0.78rem; opacity: 0.6; }

    .word-card {
      border: 1px solid currentColor;
      padding: 1.8rem 1.5rem; margin-bottom: 1.2rem;
      text-align: center; position: relative;
      min-height: 110px; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 0.4rem;
    }
    .word-lang-tag {
      font-size: 0.65rem; letter-spacing: 0.15em;
      text-transform: uppercase; opacity: 0.4;
      position: absolute; top: 0.5rem; left: 0.8rem;
    }
    .word-category {
      font-size: 0.65rem; letter-spacing: 0.1em;
      text-transform: uppercase; opacity: 0.3;
      position: absolute; top: 0.5rem; right: 0.8rem;
    }
    .word-main {
      font-size: 2rem; font-weight: bold;
      letter-spacing: 0.03em; line-height: 1.1;
    }
    .word-loading {
      font-size: 0.85rem; opacity: 0.4;
      letter-spacing: 0.12em;
      animation: pulse 1.2s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100%{opacity:0.2} 50%{opacity:0.6} }

    .answers {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 0.6rem; margin-bottom: 1rem;
    }
    .ans-btn {
      background: transparent; border: 1px solid currentColor;
      color: inherit; font: inherit; font-size: 0.88rem;
      padding: 0.75rem 0.6rem; cursor: pointer;
      text-align: left; letter-spacing: 0.03em;
      transition: opacity 0.15s, border-color 0.2s, color 0.2s;
      display: flex; align-items: center; gap: 0.5rem;
      line-height: 1.3;
    }
    .ans-btn:hover:not(:disabled) { opacity: 0.7; }
    .ans-btn:disabled { cursor: default; }
    .ans-letter {
      font-size: 0.7rem; letter-spacing: 0.1em;
      opacity: 0.45; min-width: 1.2em; font-weight: bold;
    }
    .ans-btn.correct { border-color: #2ecc71; color: #2ecc71; }
    .ans-btn.correct .ans-letter { opacity: 1; }
    .ans-btn.wrong { border-color: #e74c3c; color: #e74c3c; opacity: 0.7; }
    .ans-btn.reveal { border-color: #2ecc71; color: #2ecc71; opacity: 0.55; }

    .feedback {
      font-size: 0.8rem; letter-spacing: 0.06em;
      text-align: center; min-height: 1.4em;
      margin-bottom: 0.6rem; font-style: italic;
      opacity: 0; transition: opacity 0.3s;
    }
    .feedback.show { opacity: 0.8; }
    .feedback.ok   { color: #2ecc71; }
    .feedback.fail { color: #e74c3c; }

    .next-btn {
      display: block; width: 100%;
      background: transparent; border: 1px solid currentColor;
      color: inherit; font: inherit; font-size: 0.82rem;
      padding: 0.65rem; cursor: pointer;
      text-transform: uppercase; letter-spacing: 0.12em;
      opacity: 0; pointer-events: none; transition: opacity 0.3s;
    }
    .next-btn.show { opacity: 1; pointer-events: all; }
    .next-btn:hover { opacity: 0.65 !important; }

    .streak-badge {
      text-align: center; font-size: 0.78rem;
      letter-spacing: 0.08em; opacity: 0;
      transition: opacity 0.4s; margin-top: 0.4rem;
    }
    .streak-badge.show { opacity: 0.7; }

    .err-box {
      border: 1px solid #e74c3c; border-left-width: 3px;
      padding: 0.7rem 1rem; font-size: 0.78rem;
      color: #e74c3c; margin-bottom: 1rem;
      display: none; line-height: 1.7;
    }
    .err-box.show { display: block; }
  </style>
</head>
<body class="dark">
  <header>
    <h1>Quiz SÅ‚Ã³wek</h1>
    <nav>
      <a href="../index.html">Strona gÅ‚Ã³wna</a>
      <a href="../o-mnie.html">O mnie</a>
      <a href="../galeria.html">Galeria</a>
      <a href="../wpisy.html">Wpisy</a>
    </nav>
  </header>

  <main style="max-width: 700px; padding: 1rem;">
    <article>
      <p><em>Data publikacji: 2025-06-07</em></p>
      <p>Wybierz jÄ™zyk i tÅ‚umacz sÅ‚owa na polski. SÅ‚owa pobierane sÄ… z WikisÅ‚ownika, tÅ‚umaczenia z MyMemory â€” bez rejestracji, bez klucza.</p>

      <div id="quiz-root">

        <div id="lang-screen">
          <h2>Wybierz jÄ™zyk</h2>
          <div class="lang-grid" id="lang-grid"></div>
          <div class="diff-row">
            <span class="diff-label">Poziom:</span>
            <button class="diff-btn active" data-diff="easy"   onclick="setDiff(this)">Åatwy</button>
            <button class="diff-btn"        data-diff="medium" onclick="setDiff(this)">Åšredni</button>
            <button class="diff-btn"        data-diff="hard"   onclick="setDiff(this)">Trudny</button>
          </div>
          <button class="start-btn" id="start-btn" onclick="startQuiz()" disabled>Rozpocznij â†’</button>
          <div class="info-note">
            SÅ‚owa: Wiktionary API Â· TÅ‚umaczenia: MyMemory API<br>
            Darmowe, bez klucza, bez rejestracji
          </div>
        </div>

        <div id="quiz-screen">
          <div class="quiz-meta">
            <span id="quiz-lang-label"></span>
            <span id="quiz-diff-label"></span>
            <button onclick="goBack()">â† zmieÅ„ jÄ™zyk</button>
          </div>
          <div class="score-bar" id="score-bar">
            <span class="score-label" id="score-label">0 / 0</span>
          </div>
          <div class="err-box" id="err-box"></div>
          <div class="word-card" id="word-card">
            <div class="word-loading">ÅadujÄ™<span id="load-dots">...</span></div>
          </div>
          <div class="answers" id="answers"></div>
          <div class="feedback" id="feedback"></div>
          <button class="next-btn" id="next-btn" onclick="nextQuestion()">NastÄ™pne sÅ‚owo â†’</button>
          <div class="streak-badge" id="streak-badge"></div>
        </div>

      </div>
    </article>
  </main>

  <footer><p>Â© 2025 BiccCorp</p></footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LANGUAGES & WIKTIONARY CATEGORIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Wiktionary category format: en.wiktionary.org/w/api.php
// Categories like "de:Food and drink", "fr:Basic words" etc.
// We use English Wiktionary (en.wiktionary.org) which has entries
// for all languages tagged with their language categories.

const LANGUAGES = [
  { code:'en', name:'Angielski',  flag:'ğŸ‡¬ğŸ‡§', mmCode:'en-GB' },
  { code:'de', name:'Niemiecki',  flag:'ğŸ‡©ğŸ‡ª', mmCode:'de-DE' },
  { code:'es', name:'HiszpaÅ„ski', flag:'ğŸ‡ªğŸ‡¸', mmCode:'es-ES' },
  { code:'fr', name:'Francuski',  flag:'ğŸ‡«ğŸ‡·', mmCode:'fr-FR' },
  { code:'it', name:'WÅ‚oski',     flag:'ğŸ‡®ğŸ‡¹', mmCode:'it-IT' },
  { code:'ru', name:'Rosyjski',   flag:'ğŸ‡·ğŸ‡º', mmCode:'ru-RU' },
  { code:'pt', name:'Portugalski',flag:'ğŸ‡µğŸ‡¹', mmCode:'pt-PT' },
];

// Wiktionary categories per language per difficulty
// Format: Category name on en.wiktionary.org (without "Category:" prefix)
const WIKT_CATS = {
  en: {
    easy:   ['en:Food and drink','en:Colors','en:Family','en:Animals','en:Body','en:Clothing'],
    medium: ['en:Emotions','en:Weather','en:Travel','en:Sports','en:Education','en:Work'],
    hard:   ['en:Philosophy','en:Politics','en:Economics','en:Science','en:Law','en:Medicine'],
  },
  de: {
    easy:   ['de:Food and drink','de:Colors','de:Family','de:Animals','de:Body','de:Clothing'],
    medium: ['de:Emotions','de:Weather','de:Travel','de:Sports','de:Education','de:Work'],
    hard:   ['de:Philosophy','de:Politics','de:Economics','de:Science','de:Law','de:Medicine'],
  },
  es: {
    easy:   ['es:Food and drink','es:Colors','es:Family','es:Animals','es:Body','es:Clothing'],
    medium: ['es:Emotions','es:Weather','es:Travel','es:Sports','es:Education','es:Work'],
    hard:   ['es:Philosophy','es:Politics','es:Economics','es:Science','es:Law','es:Medicine'],
  },
  fr: {
    easy:   ['fr:Food and drink','fr:Colors','fr:Family','fr:Animals','fr:Body','fr:Clothing'],
    medium: ['fr:Emotions','fr:Weather','fr:Travel','fr:Sports','fr:Education','fr:Work'],
    hard:   ['fr:Philosophy','fr:Politics','fr:Economics','fr:Science','fr:Law','fr:Medicine'],
  },
  it: {
    easy:   ['it:Food and drink','it:Colors','it:Family','it:Animals','it:Body','it:Clothing'],
    medium: ['it:Emotions','it:Weather','it:Travel','it:Sports','it:Education','it:Work'],
    hard:   ['it:Philosophy','it:Politics','it:Economics','it:Science','it:Law','it:Medicine'],
  },
  ru: {
    easy:   ['ru:Food and drink','ru:Colors','ru:Family','ru:Animals','ru:Body','ru:Clothing'],
    medium: ['ru:Emotions','ru:Weather','ru:Travel','ru:Sports','ru:Education','ru:Work'],
    hard:   ['ru:Philosophy','ru:Politics','ru:Economics','ru:Science','ru:Law','ru:Medicine'],
  },
  pt: {
    easy:   ['pt:Food and drink','pt:Colors','pt:Family','pt:Animals','pt:Body','pt:Clothing'],
    medium: ['pt:Emotions','pt:Weather','pt:Travel','pt:Sports','pt:Education','pt:Work'],
    hard:   ['pt:Philosophy','pt:Politics','pt:Economics','pt:Science','pt:Law','pt:Medicine'],
  },
};

// Human-readable category names (for display)
const CAT_LABELS = {
  'Food and drink':'jedzenie','Colors':'kolory','Family':'rodzina',
  'Animals':'zwierzÄ™ta','Body':'ciaÅ‚o','Clothing':'ubrania',
  'Emotions':'emocje','Weather':'pogoda','Travel':'podrÃ³Å¼e',
  'Sports':'sport','Education':'edukacja','Work':'praca',
  'Philosophy':'filozofia','Politics':'polityka','Economics':'ekonomia',
  'Science':'nauka','Law':'prawo','Medicine':'medycyna',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WIKTIONARY WORD CACHE
//  We fetch 50 words per category and cache them
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const wiktCache = {}; // key: "lang:cat" â†’ [words...]
const WIKT_API  = 'https://en.wiktionary.org/w/api.php';

async function fetchCategoryWords(category, langCode) {
  const key = langCode + ':' + category;
  if (wiktCache[key] && wiktCache[key].length > 0) return wiktCache[key];

  // Fetch up to 500 members, pick random offset
  const params = new URLSearchParams({
    action:    'query',
    list:      'categorymembers',
    cmtitle:   'Category:' + category,
    cmlimit:   '500',
    cmnamespace:'0',
    format:    'json',
    origin:    '*',   // required for CORS
  });

  const res  = await fetch(WIKT_API + '?' + params);
  const data = await res.json();
  const members = data?.query?.categorymembers || [];

  // Filter: only single words (no spaces, no special chars), not too short/long
  const words = members
    .map(m => m.title)
    .filter(w =>
      !w.includes(' ') &&
      !w.includes('-') &&
      !w.includes('/') &&
      w.length >= 3 &&
      w.length <= 18 &&
      // exclude proper nouns (starts with uppercase) for non-Russian
      (langCode === 'ru' || w[0] === w[0].toLowerCase())
    );

  if (words.length === 0) throw new Error('Brak sÅ‚Ã³w w kategorii: ' + category);

  wiktCache[key] = shuffle([...words]);
  return wiktCache[key];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selectedLang  = null;
let difficulty    = 'easy';
let score         = { correct:0, total:0 };
let streak        = 0;
let answered      = false;
let usedWords     = new Set();
let scoreHistory  = [];
let dotTimer      = null;
let currentPool   = []; // words fetched for this session

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUILD LANG GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLangGrid() {
  const grid = document.getElementById('lang-grid');
  LANGUAGES.forEach(lang => {
    const btn = document.createElement('button');
    btn.className = 'lang-btn';
    btn.innerHTML = `<span class="lang-flag">${lang.flag}</span><span>${lang.name}</span>`;
    btn.onclick = () => {
      selectedLang = lang;
      document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById('start-btn').disabled = false;
    };
    grid.appendChild(btn);
  });
}
buildLangGrid();

function setDiff(btn) {
  difficulty = btn.dataset.diff;
  document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startQuiz() {
  if (!selectedLang) return;
  score = { correct:0, total:0 };
  streak = 0; usedWords = new Set(); scoreHistory = []; currentPool = [];
  wiktCache; // keep cache between sessions

  document.getElementById('lang-screen').style.display = 'none';
  document.getElementById('quiz-screen').style.display = 'block';
  document.getElementById('quiz-lang-label').textContent = selectedLang.flag + ' ' + selectedLang.name;
  document.getElementById('quiz-diff-label').textContent =
    { easy:'ÅATWY', medium:'ÅšREDNI', hard:'TRUDNY' }[difficulty];

  buildScoreBar();
  loadQuestion();
}

function goBack() {
  clearInterval(dotTimer);
  document.getElementById('quiz-screen').style.display = 'none';
  document.getElementById('lang-screen').style.display = 'block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCORE BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SEG = 10;
function buildScoreBar() {
  const bar = document.getElementById('score-bar');
  bar.querySelectorAll('.score-seg').forEach(s => s.remove());
  const lbl = document.getElementById('score-label');
  for (let i = 0; i < SEG; i++) {
    const s = document.createElement('div');
    s.className = 'score-seg';
    bar.insertBefore(s, lbl);
  }
  refreshScoreBar();
}
function refreshScoreBar() {
  document.querySelectorAll('.score-seg').forEach((seg, i) => {
    seg.className = 'score-seg';
    const h = scoreHistory[scoreHistory.length - SEG + i];
    if (h === true)  seg.classList.add('correct');
    if (h === false) seg.classList.add('wrong');
  });
  document.getElementById('score-label').textContent = score.correct + ' / ' + score.total;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startDots() {
  let n = 0;
  clearInterval(dotTimer);
  dotTimer = setInterval(() => {
    const el = document.getElementById('load-dots');
    if (el) el.textContent = '.'.repeat((n++ % 3) + 1);
  }, 350);
}
function stopDots() { clearInterval(dotTimer); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSLATE via MyMemory
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function translate(word, mmCode) {
  const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=${mmCode}|pl-PL`;
  const res  = await fetch(url);
  const data = await res.json();
  if (data.responseStatus !== 200) throw new Error('MyMemory: ' + data.responseMessage);
  let t = data.responseData.translatedText;
  // normalize ALL-CAPS short results
  if (t === t.toUpperCase() && t.length > 2) {
    t = t.charAt(0).toUpperCase() + t.slice(1).toLowerCase();
  }
  // reject if translation == original (untranslated)
  if (t.toLowerCase().trim() === word.toLowerCase().trim()) throw new Error('Brak tÅ‚umaczenia');
  return t.trim();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PICK WORD + FETCH IF NEEDED
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function pickWordFromWiktionary() {
  const cats = WIKT_CATS[selectedLang.code][difficulty];

  // Refill pool if empty
  if (currentPool.length === 0) {
    // fetch all cats in parallel, merge
    const results = await Promise.allSettled(
      cats.map(cat => fetchCategoryWords(cat, selectedLang.code).then(words => ({ cat, words })))
    );
    const merged = [];
    results.forEach(r => {
      if (r.status === 'fulfilled') {
        r.value.words.forEach(w => merged.push({ word: w, cat: r.value.cat }));
      }
    });
    if (merged.length === 0) throw new Error('Nie udaÅ‚o siÄ™ pobraÄ‡ sÅ‚Ã³w z WikisÅ‚ownika');
    currentPool = shuffle(merged);
  }

  // Pop words until we find one not used
  let attempts = 0;
  while (currentPool.length > 0 && attempts < 200) {
    attempts++;
    const item = currentPool.pop();
    if (!usedWords.has(item.word)) {
      usedWords.add(item.word);
      return item;
    }
  }

  // All used â€” reset
  usedWords.clear();
  currentPool = [];
  return pickWordFromWiktionary();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD QUESTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadQuestion() {
  answered = false;
  document.getElementById('err-box').className      = 'err-box';
  document.getElementById('feedback').className     = 'feedback';
  document.getElementById('next-btn').className     = 'next-btn';
  document.getElementById('streak-badge').className = 'streak-badge';
  document.getElementById('answers').innerHTML      = '';
  document.getElementById('word-card').innerHTML    =
    `<div class="word-loading">Pobieram sÅ‚Ã³wko<span id="load-dots">.</span></div>`;
  startDots();

  try {
    // 1. Get word from Wiktionary
    const { word, cat } = await pickWordFromWiktionary();

    // 2. Translate correct word
    const correctPl = await translate(word, selectedLang.mmCode);

    // 3. Get 3 more words for distractors and translate them
    const distractorWords = [];
    let poolCopy = [...currentPool];
    shuffle(poolCopy);
    for (const item of poolCopy) {
      if (distractorWords.length >= 6) break;
      if (!usedWords.has(item.word) && item.word !== word) {
        distractorWords.push(item.word);
      }
    }

    const wrongTranslations = [];
    for (const dw of distractorWords) {
      if (wrongTranslations.length >= 3) break;
      try {
        const t = await translate(dw, selectedLang.mmCode);
        const norm = t.toLowerCase().trim();
        const isDupe = norm === correctPl.toLowerCase().trim() ||
                       wrongTranslations.some(x => x.toLowerCase().trim() === norm);
        if (!isDupe && t.length > 0) wrongTranslations.push(t);
      } catch(_) { /* skip */ }
    }

    // Fallback if not enough distractors
    while (wrongTranslations.length < 3) wrongTranslations.push('â€”');

    stopDots();

    // Label from category name
    const catLabel = CAT_LABELS[cat.split(':')[1]] || cat.split(':')[1] || '';

    renderQuestion({ word, catLabel, correct: correctPl, wrong: wrongTranslations });

  } catch(err) {
    stopDots();
    document.getElementById('word-card').innerHTML =
      `<div class="word-loading" style="color:#e74c3c">BÅ‚Ä…d Å‚adowania</div>`;
    const errEl = document.getElementById('err-box');
    errEl.textContent = 'âš  ' + err.message + ' â€” sprÃ³buj ponownie.';
    errEl.className = 'err-box show';
    document.getElementById('next-btn').className = 'next-btn show';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderQuestion({ word, catLabel, correct, wrong }) {
  document.getElementById('word-card').innerHTML = `
    <div class="word-lang-tag">${selectedLang.flag} ${selectedLang.name}</div>
    ${catLabel ? `<div class="word-category">${catLabel}</div>` : ''}
    <div class="word-main">${word}</div>
  `;

  const options = shuffle([
    { text: correct, correct: true },
    { text: wrong[0], correct: false },
    { text: wrong[1], correct: false },
    { text: wrong[2], correct: false },
  ]);

  const letters = ['A','B','C','D'];
  const container = document.getElementById('answers');
  container.innerHTML = '';
  options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'ans-btn';
    btn.innerHTML = `<span class="ans-letter">${letters[i]}</span><span>${opt.text}</span>`;
    btn.onclick = () => onAnswer(opt.correct, btn, correct);
    container.appendChild(btn);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANSWER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onAnswer(isCorrect, clickedBtn, correctText) {
  if (answered) return;
  answered = true;
  score.total++;

  document.querySelectorAll('.ans-btn').forEach(b => { b.disabled = true; });
  const fb = document.getElementById('feedback');

  if (isCorrect) {
    score.correct++;
    streak++;
    clickedBtn.classList.add('correct');
    fb.textContent = streak >= 3 ? `âœ“ Åšwietnie! Seria: ${streak} ğŸ”¥` : 'âœ“ Poprawnie!';
    fb.className = 'feedback show ok';
  } else {
    streak = 0;
    clickedBtn.classList.add('wrong');
    document.querySelectorAll('.ans-btn').forEach(b => {
      if (b.querySelectorAll('span')[1]?.textContent === correctText) b.classList.add('reveal');
    });
    fb.textContent = `âœ— BÅ‚Ä…d. Poprawna: ${correctText}`;
    fb.className = 'feedback show fail';
  }

  scoreHistory.push(isCorrect);
  refreshScoreBar();

  if (streak >= 3) {
    const badge = document.getElementById('streak-badge');
    badge.textContent = `ğŸ”¥ Seria ${streak} poprawnych z rzÄ™du!`;
    badge.className = 'streak-badge show';
  }

  document.getElementById('next-btn').className = 'next-btn show';
}

function nextQuestion() { loadQuestion(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
</script>
</body>
</html>